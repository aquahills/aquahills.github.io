let price = 75; // default fallback

document.addEventListener("DOMContentLoaded", async () => {

  const qtyInput = document.getElementById("qty");
  const totalEl = document.getElementById("total");

  // Show default price immediately
  totalEl.innerText = qtyInput.value * price;

  firebase.auth().onAuthStateChanged(async (user) => {

    if (!user) {
      window.location.href = "login.html";
      return;
    }

    try {

      const settings = await api("getSettings");

      if (!settings.error && settings.price) {
        price = Number(settings.price);
      }

      totalEl.innerText = qtyInput.value * price;

      qtyInput.addEventListener("input", e => {
        totalEl.innerText = e.target.value * price;
      });

    } catch (err) {
      console.error(err);
      alert("Unable to fetch price.");
    }

  });
});

async function confirmOrder() {

  const qty = Number(document.getElementById("qty").value);

  if (!qty || qty <= 0) {
    alert("Invalid quantity");
    return;
  }

  try {

    const res = await api("createOrder", { bottles: qty });

    if (res.error) {
      alert(res.error);
      return;
    }

    alert("Order placed successfully");
    window.location.href = "orders.html";

  } catch (err) {
    alert("Order failed. Try again.");
  }
}
