<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body { margin:0; overflow-x:hidden; }

/* TOPBAR */
.topbar{
  height:65px;
  display:flex;
  align-items:center;
  padding:0 20px;
  background:rgba(0,0,0,0.35);
  backdrop-filter:blur(10px);
}
.menu-btn{ font-size:24px; cursor:pointer; margin-right:15px; }

/* SIDEBAR */
.sidebar{
  position:fixed;
  left:-250px;
  top:0;
  width:240px;
  height:100%;
  background:linear-gradient(180deg,#062c5c,#0a5fd8);
  padding:25px 15px;
  transition:.3s;
  z-index:1001;
}
.sidebar.active{ left:0; }
.sidebar button{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:25px;
  border:1px solid rgba(255,255,255,.3);
  background:transparent;
  color:white;
  font-weight:600;
  cursor:pointer;
}
.sidebar button:hover{
  background:white;
  color:#0a5fd8;
}

.overlay{
  position:fixed;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.4);
  display:none;
  z-index:1000;
}
.overlay.active{ display:block; }

/* CONTENT */
.content{
  display:flex;
  justify-content:center;
  padding:30px 15px 60px;
  min-height:calc(100vh - 65px);
}

.admin-card{
  width:100%;
  max-width:1200px;
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(15px);
  padding:25px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}

/* FILTER ROW */
.filter-row{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  margin-bottom:20px;
}

.filter-row input,
.filter-row select{
  padding:8px 12px;
  border-radius:8px;
  border:none;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.2);
}
th{ text-align:left; }

.action-btn{
  padding:6px 12px;
  border:none;
  border-radius:15px;
  cursor:pointer;
  font-weight:600;
}
.edit-btn{ background:white; color:#0a5fd8; }
.delete-btn{ background:#ff4d4d; color:white; }

/* PAGINATION */
.pagination{
  margin-top:20px;
  display:flex;
  justify-content:center;
  gap:10px;
}
.pagination button{
  padding:6px 12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
}

/* MODAL */
.modal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:2000;
}
.modal-content{
  background:white;
  color:#062c5c;
  padding:25px;
  border-radius:15px;
  width:90%;
  max-width:400px;
  text-align:center;
}
.modal-content button{
  margin:10px;
  padding:8px 18px;
  border:none;
  border-radius:20px;
  cursor:pointer;
}

/* MOBILE VIEW */
@media(max-width:768px){
  table{ display:none; }
  .mobile-card{
    background:rgba(255,255,255,.2);
    padding:15px;
    border-radius:15px;
    margin-bottom:15px;
  }
}
</style>
</head>

<body>

<div class="topbar">
  <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
  <h3>Admin Panel</h3>
</div>

<div class="sidebar" id="sidebar">
  <button onclick="navigate('users')">Users</button>
  <button onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="content">
  <div class="admin-card" id="contentArea">Loading...</div>
</div>

<div class="modal" id="confirmModal">
  <div class="modal-content">
    <h3>Confirm Delete</h3>
    <p>Are you sure you want to delete this user?</p>
    <button onclick="confirmDelete()">Yes</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<script src="js/firebase.js"></script>

<script>
let usersData=[];
let currentPage=1;
let usersPerPage=5;
let deleteId=null;

function toggleSidebar(){
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}
function closeSidebar(){
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
}
function navigate(section){
  closeSidebar();
  if(section==="users") loadUsers();
}
function logout(){
  firebase.auth().signOut().then(()=>window.location.href="index.html");
}

firebase.auth().onAuthStateChanged(async user=>{
  if(!user) return window.location.href="login.html";
  const doc=await db.collection("users").doc(user.uid).get();
  if(doc.data()?.role!=="admin") return window.location.href="index.html";
  loadUsers();
});

async function loadUsers(){
  const snapshot=await db.collection("users").get();
  usersData=[];
  snapshot.forEach(doc=>{
    usersData.push({id:doc.id,...doc.data()});
  });
  renderUsers();
}

function renderUsers(){
  const search=document.getElementById("searchInput")?.value?.toLowerCase()||"";
  const roleFilter=document.getElementById("roleFilter")?.value||"all";

  let filtered=usersData.filter(u=>{
    const matchSearch=u.name?.toLowerCase().includes(search)||u.phone?.includes(search);
    const matchRole=roleFilter==="all"||u.role===roleFilter;
    return matchSearch&&matchRole;
  });

  const start=(currentPage-1)*usersPerPage;
  const paginated=filtered.slice(start,start+usersPerPage);

  let tableRows="";
  let mobileRows="";

  paginated.forEach(u=>{
    tableRows+=`
      <tr>
        <td>${u.name||""}</td>
        <td>${u.phone||""}</td>
        <td>${u.role}</td>
        <td>
          <button class="action-btn delete-btn" onclick="openModal('${u.id}')">Delete</button>
        </td>
      </tr>
    `;
    mobileRows+=`
      <div class="mobile-card">
        <p><strong>Name:</strong> ${u.name||""}</p>
        <p><strong>Phone:</strong> ${u.phone||""}</p>
        <p><strong>Role:</strong> ${u.role}</p>
        <button class="action-btn delete-btn" onclick="openModal('${u.id}')">Delete</button>
      </div>
    `;
  });

  let totalPages=Math.ceil(filtered.length/usersPerPage);
  let paginationBtns="";
  for(let i=1;i<=totalPages;i++){
    paginationBtns+=`<button onclick="changePage(${i})">${i}</button>`;
  }

  contentArea.innerHTML=`
    <h2>Users</h2>

    <div class="filter-row">
      <input type="text" id="searchInput" placeholder="Search..." oninput="renderUsers()">
      <select id="roleFilter" onchange="renderUsers()">
        <option value="all">All Roles</option>
        <option value="customer">Customer</option>
        <option value="delivery">Delivery</option>
        <option value="admin">Admin</option>
      </select>
    </div>

    <table>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Role</th>
        <th>Action</th>
      </tr>
      ${tableRows}
    </table>

    ${mobileRows}

    <div class="pagination">${paginationBtns}</div>
  `;
}

function changePage(page){
  currentPage=page;
  renderUsers();
}

function openModal(id){
  deleteId=id;
  confirmModal.style.display="flex";
}
function closeModal(){
  confirmModal.style.display="none";
}
async function confirmDelete(){
  if(deleteId){
    await db.collection("users").doc(deleteId).delete();
    closeModal();
    loadUsers();
  }
}
</script>

</body>
</html>
