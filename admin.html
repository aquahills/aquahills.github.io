<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <link rel="stylesheet" href="css/style.css">

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body { margin:0; overflow-x:hidden; }

.topbar{
  height:70px;
  display:flex;
  align-items:center;
  padding:0 25px;
  background:rgba(0,0,0,0.3);
}

.menu-btn{ font-size:26px; cursor:pointer; margin-right:15px; }

.sidebar{
  position:fixed;
  left:-260px;
  top:0;
  width:250px;
  height:100%;
  background:linear-gradient(180deg,#062c5c,#0a5fd8);
  padding:30px 20px;
  transition:.3s;
  z-index:1001;
}

.sidebar.active{ left:0; }

.sidebar button{
  width:100%;
  padding:12px;
  margin-bottom:15px;
  border-radius:25px;
  border:1px solid rgba(255,255,255,.3);
  background:transparent;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.sidebar button:hover{ background:white; color:#0a5fd8; }

.overlay{
  position:fixed;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.4);
  display:none;
  z-index:1000;
}

.overlay.active{ display:block; }

.content{
  display:flex;
  justify-content:center;
  padding:40px 20px;
}

.wrapper{
  width:100%;
  max-width:1100px;
}

.admin-card{
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(15px);
  padding:30px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}

.dashboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:25px;
}

.stat{
  background:rgba(255,255,255,.2);
  padding:35px;
  border-radius:18px;
  text-align:center;
  cursor:pointer;
  transition:.3s;
}

.stat:hover{ transform:translateY(-5px); }

.stat h2{ margin:0; font-size:34px; }

.controls{
  display:flex;
  gap:15px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

input,select{
  padding:8px 10px;
  border-radius:10px;
  border:none;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.2);
}

.action-btn{
  padding:6px 12px;
  border-radius:15px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.edit-btn{ background:white; color:#0a5fd8; }
.delete-btn{ background:#ff4d4d; color:white; }
.success-btn{ background:#00b4ff; color:white; }

.primary-theme-btn{
  padding:10px 25px;
  border-radius:25px;
  border:none;
  background:white;
  color:#0a5fd8;
  font-weight:bold;
  cursor:pointer;
}

@media(max-width:768px){
  .content{ padding:20px 15px; }
}
</style>
</head>

<body>

<div class="topbar">
  <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
  <h3>Admin Panel</h3>
</div>

<div class="sidebar" id="sidebar">
  <button onclick="navigate('dashboard')">Dashboard</button>
  <button onclick="navigate('ordersSummary')">Orders</button>
  <button onclick="navigate('users')">Users</button>
  <button onclick="navigate('settings')">Settings</button>
  <button onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="content">
  <div class="wrapper" id="contentArea"></div>
</div>

<script src="js/firebase.js"></script>

<script>
function toggleSidebar(){
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}
function closeSidebar(){
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
}
function navigate(section){
  closeSidebar();
  showSection(section);
}

firebase.auth().onAuthStateChanged(async(user)=>{
  if(!user) return location.href="login.html";
  const doc=await db.collection("users").doc(user.uid).get();
  if(doc.data()?.role!=="admin") return location.href="index.html";
  showSection("dashboard");
});

function logout(){
  firebase.auth().signOut().then(()=>location.href="index.html");
}

function showSection(section){
  if(section==="dashboard") loadDashboard();
  if(section==="users") loadUsers();
  if(section==="settings") loadSettings();
  if(section==="ordersSummary") loadOrdersSummary();
  if(section==="activeOrders") loadActiveOrders();
}

/* DASHBOARD */
async function loadDashboard(){
  const orders=await db.collection("orders").get();
  const users=await db.collection("users").get();
  const active=orders.docs.filter(d=>d.data().status!=="Delivered");

  contentArea.innerHTML=`
    <div class="admin-card">
      <div class="dashboard-grid">
        <div class="stat" onclick="navigate('users')">
          <h2>ðŸ‘¥ ${users.size}</h2>
          <p>All Users</p>
        </div>
        <div class="stat" onclick="navigate('activeOrders')">
          <h2>ðŸ“¦ ${active.length}</h2>
          <p>Active Orders</p>
        </div>
      </div>
    </div>`;
}

/* ACTIVE ORDERS */
async function loadActiveOrders(){
  const snap=await db.collection("orders")
    .where("status","!=","Delivered").get();

  let rows="";
  for(const doc of snap.docs){
    const o=doc.data();
    const userDoc=await db.collection("users").doc(o.customerId).get();
    const u=userDoc.data()||{};
    rows+=`
      <tr>
        <td>${u.name||""}</td>
        <td>${u.phone||""}</td>
        <td>${o.bottles}</td>
        <td>â‚¹${o.total}</td>
        <td>
          <button class="success-btn"
            onclick="markDelivered('${doc.id}')">Mark Delivered</button>
        </td>
      </tr>`;
  }

  contentArea.innerHTML=`
    <div class="admin-card">
      <h2>Active Orders</h2>
      <table>
        <tr>
          <th>Name</th><th>Phone</th>
          <th>Bottles</th><th>Total</th><th>Action</th>
        </tr>
        ${rows}
      </table>
    </div>`;
}

async function markDelivered(id){
  await db.collection("orders").doc(id).update({status:"Delivered"});
  loadActiveOrders();
}

/* USERS */
async function loadUsers(){
  const snap=await db.collection("users").get();
  let rows="";
  snap.forEach(doc=>{
    const u=doc.data();
    rows+=`
      <tr>
        <td>${u.name||""}</td>
        <td>${u.phone||""}</td>
        <td>${u.role}</td>
        <td>
          <button class="edit-btn"
            onclick="editUser('${doc.id}')">Edit</button>
          <button class="delete-btn"
            onclick="deleteUser('${doc.id}')">Delete</button>
        </td>
      </tr>`;
  });

  contentArea.innerHTML=`
    <div class="admin-card">
      <h2>All Users</h2>
      <table>
        <tr>
          <th>Name</th><th>Phone</th>
          <th>Role</th><th>Action</th>
        </tr>
        ${rows}
      </table>
    </div>`;
}

function editUser(id){
  const newRole=prompt("Enter role (admin/customer/delivery)");
  if(!newRole) return;
  db.collection("users").doc(id).update({role:newRole});
  loadUsers();
}

function deleteUser(id){
  if(confirm("Delete this user?")){
    db.collection("users").doc(id).delete();
    loadUsers();
  }
}

/* ORDERS SUMMARY */
async function loadOrdersSummary(){
  const orders=await db.collection("orders").get();
  const users=await db.collection("users").get();

  const map={};
  orders.forEach(o=>{
    const d=o.data();
    if(!map[d.customerId]) map[d.customerId]=[];
    map[d.customerId].push(d);
  });

  let rows="";
  users.forEach(u=>{
    const id=u.id;
    const data=u.data();
    const userOrders=map[id]||[];
    if(userOrders.length===0) return;
    const last=userOrders.sort((a,b)=>b.createdAt?.seconds-a.createdAt?.seconds)[0];

    rows+=`
      <tr>
        <td>${data.name||""}</td>
        <td>${userOrders.length}</td>
        <td>${last?.createdAt?.toDate().toLocaleDateString()||""}</td>
        <td>
          <button class="primary-theme-btn"
            onclick="showUserOrders('${id}')">
            Show All Orders
          </button>
        </td>
      </tr>`;
  });

  contentArea.innerHTML=`
    <div class="admin-card">
      <h2>Orders Summary</h2>
      <table>
        <tr>
          <th>Name</th>
          <th>Orders Placed</th>
          <th>Last Order</th>
          <th>Action</th>
        </tr>
        ${rows}
      </table>
    </div>`;
}

async function showUserOrders(userId){
  const snap=await db.collection("orders")
    .where("customerId","==",userId)
    .get();

  let rows="";
  snap.forEach(doc=>{
    const o=doc.data();
    rows+=`
      <tr>
        <td>${o.bottles}</td>
        <td>â‚¹${o.total}</td>
        <td>${o.status}</td>
      </tr>`;
  });

  contentArea.innerHTML=`
    <div class="admin-card">
      <h2>User Orders</h2>
      <table>
        <tr><th>Bottles</th><th>Total</th><th>Status</th></tr>
        ${rows}
      </table>
      <br>
      <button class="primary-theme-btn"
        onclick="navigate('ordersSummary')">Back</button>
    </div>`;
}

/* SETTINGS */
async function loadSettings(){
  const doc=await db.collection("settings").doc("global").get();
  const price=doc.data()?.price||75;

  contentArea.innerHTML=`
    <div class="admin-card">
      <h2>Settings</h2>
      <p>Bottle Price</p>
      <input type="number" id="priceInput" value="${price}">
      <br><br>
      <button class="primary-theme-btn"
        onclick="savePrice()">Save</button>
    </div>`;
}

async function savePrice(){
  const price=Number(priceInput.value);
  await db.collection("settings").doc("global").update({price});
  alert("Updated");
}
</script>

</body>
</html>
